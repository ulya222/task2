<Window x:Class="DataVault.Client.Screens.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:DataVault.Client.ViewModels"
        Title="DataVault — Учёт ресурсов и задач" Height="720" Width="1100" WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}" FontFamily="{StaticResource AppFont}">
    <Window.DataContext><vm:MainViewModel/></Window.DataContext>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Левая панель навигации -->
        <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,1,0" Padding="0">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="DataVault" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="16,20,16,24" HorizontalAlignment="Center"/>
                <StackPanel DockPanel.Dock="Bottom" Margin="12,0,12,16" VerticalAlignment="Bottom">
                    <Button x:Name="ThemeToggleBtn" Content="Светлая тема" Click="ThemeToggle_Click" Style="{DynamicResource SecondaryButton}" Margin="0,0,0,8" HorizontalAlignment="Stretch"/>
                    <Separator Margin="0,4" Background="{DynamicResource BorderBrush}"/>
                    <Button Content="Завершить сеанс" Command="{Binding EndSessionCommand}" Foreground="{DynamicResource AccentBrush}" Style="{DynamicResource SecondaryButton}" HorizontalAlignment="Stretch"/>
                </StackPanel>
                <ListBox DockPanel.Dock="Top" SelectedIndex="{Binding ActivePageIndex, Mode=TwoWay}" Background="Transparent" BorderThickness="0"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled" Padding="8,0">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="12,10"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Bd" Background="Transparent" CornerRadius="6" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                                                <Setter Property="Foreground" Value="White"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource BorderBrush}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBoxItem Content="Сводка"/>
                    <ListBoxItem Content="Ресурсы"/>
                    <ListBoxItem Content="Задачи"/>
                    <ListBoxItem Content="Проверки"/>
                    <ListBoxItem Content="Обзор"/>
                </ListBox>
            </DockPanel>
        </Border>

        <!-- Область контента (вкладки без заголовков) -->
        <Grid Grid.Column="1" Margin="20,16">
            <TabControl SelectedIndex="{Binding ActivePageIndex, Mode=TwoWay}" Padding="0" BorderThickness="0" Background="Transparent">
                <TabControl.Template>
                    <ControlTemplate TargetType="TabControl">
                        <ContentPresenter ContentSource="SelectedContent" Margin="0"/>
                    </ControlTemplate>
                </TabControl.Template>

                <TabItem Header="Сводка">
                    <Grid Margin="0,0,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,14">
                            <Button Content="Экспорт ресурсов (Excel)" Command="{Binding ExportResourcesCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Экспорт задач (Excel)" Command="{Binding ExportTasksCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Экспорт сводки (PDF)" Command="{Binding ExportPdfCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Уведомление: низкие остатки" Command="{Binding SendLowStockNotifyCommand}" Style="{DynamicResource SecondaryButton}"/>
                        </StackPanel>
                        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="20" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="Ключевые показатели" FontSize="15" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,14"/>
                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,14">
                                    <TextBlock Text="{Binding TasksToday, StringFormat='Задач за сегодня: {0}'}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,20,0"/>
                                    <TextBlock Text="{Binding TasksInProgress, StringFormat='В работе: {0}'}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,20,0"/>
                                    <TextBlock Text="{Binding LowStockCount, StringFormat='Низкие остатки: {0}'}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </StackPanel>
                                <Border Grid.Row="2" Background="#312E81" CornerRadius="8" Padding="14" Margin="0,6,0,0" MinHeight="80">
                                    <TextBlock Text="Показатели: задач за сегодня, в работе, позиций с низким остатком — см. выше" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </Border>
                            </Grid>
                        </Border>
                    </Grid>
                </TabItem>

                <TabItem Header="Ресурсы">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" Padding="12,10" Margin="0,0,0,10" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8">
                            <Grid>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxStyle}"
                                             BorderThickness="0" Margin="0,0,10,0" Background="Transparent" Width="260" Tag="Поиск..."/>
                                    <TextBlock Text="Код:" VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,4,0"/>
                                    <TextBox x:Name="ScanBox" Text="{Binding ScanCode, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxStyle}"
                                             Width="160" KeyDown="ScanBox_KeyDown" Tag="Сканировать и Enter"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                    <Button Content="История операций" Command="{Binding ShowTransactionsCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,6,0"/>
                                    <Button Content="Синхронизировать" Command="{Binding RefreshResourcesCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,6,0"/>
                                    <Button Content="Создать запись" Command="{Binding AddResourceCommand}" Style="{DynamicResource PrimaryButton}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding Resources}" SelectedItem="{Binding SelectedResource}" Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Код" Binding="{Binding Code}" Width="100"/>
                                <DataGridTextColumn Header="Наименование" Binding="{Binding Name}" Width="*"/>
                                <DataGridTextColumn Header="Тип" Binding="{Binding ResourceKind}" Width="120"/>
                                <DataGridTextColumn Header="Производитель" Binding="{Binding Manufacturer}" Width="110"/>
                                <DataGridTextColumn Header="Остаток" Binding="{Binding TotalStock}" Width="70"/>
                                <DataGridTextColumn Header="Мин/Макс" Binding="{Binding MinStock}" Width="70"/>
                                <DataGridTextColumn Header="Ед. изм." Binding="{Binding UnitOfMeasure}" Width="60"/>
                            </DataGrid.Columns>
                            <DataGrid.ContextMenu>
                                <ContextMenu Background="{DynamicResource SurfaceBrush}" Foreground="{DynamicResource TextPrimaryBrush}"
                                              DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                    <MenuItem Header="Создать запись" Command="{Binding AddResourceCommand}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <MenuItem Header="Изменить" Command="{Binding EditResourceCommand}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <MenuItem Header="Удалить" Command="{Binding RemoveResourceCommand}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <Separator Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <MenuItem Header="Синхронизировать" Command="{Binding RefreshResourcesCommand}"/>
                                </ContextMenu>
                            </DataGrid.ContextMenu>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <TabItem Header="Задачи">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <Button Content="Синхронизировать" Command="{Binding RefreshTasksCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Новая задача" Command="{Binding CreateTaskCommand}" Style="{DynamicResource PrimaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Изменить фазу" Command="{Binding UpdateTaskPhaseCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Состав категории" Command="{Binding OpenCategoryCompositionCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,12,0"/>
                            <TextBlock Text="Вид:" VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,4,0"/>
                            <RadioButton Content="Таблица" IsChecked="True" GroupName="TasksView" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" Margin="0,0,6,0" Checked="TasksViewTable_Checked"/>
                            <RadioButton Content="Канбан" GroupName="TasksView" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" Checked="TasksViewKanban_Checked"/>
                        </StackPanel>
                        <ScrollViewer Grid.Row="1" x:Name="KanbanScroll" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Margin="0,0,0,6" Visibility="Collapsed">
                            <ItemsControl x:Name="KanbanItemsControl" ItemsSource="{Binding TaskColumns}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="190" MinHeight="160" Margin="0,0,8,0" Background="#4338CA" CornerRadius="8" Padding="8">
                                            <StackPanel>
                                                <TextBlock Text="{Binding PhaseName}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                                                <ItemsControl ItemsSource="{Binding Tasks}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="{DynamicResource SurfaceBrush}" Padding="6" Margin="0,0,0,4" CornerRadius="4" Cursor="Hand">
                                                                <StackPanel>
                                                                    <TextBlock Foreground="{DynamicResource TextPrimaryBrush}"><Run Text="№"/><Run Text="{Binding Id}"/></TextBlock>
                                                                    <TextBlock Text="{Binding Category.Name}" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" TextTrimming="CharacterEllipsis"/>
                                                                    <TextBlock Text="{Binding PlannedFinishAt, StringFormat='План: {0:dd.MM.yy}'}" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="10"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <DataGrid Grid.Row="2" x:Name="TasksDataGrid" ItemsSource="{Binding Tasks}" SelectedItem="{Binding SelectedTask}" Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="№" Binding="{Binding Id}" Width="56"/>
                                <DataGridTextColumn Header="Категория" Binding="{Binding Category.Name}" Width="180"/>
                                <DataGridTextColumn Header="Фаза" Binding="{Binding Phase.Name}" Width="110"/>
                                <DataGridTextColumn Header="Кол-во" Binding="{Binding Quantity}" Width="60"/>
                                <DataGridTextColumn Header="Дата" Binding="{Binding CreatedAt, StringFormat=dd.MM.yyyy HH:mm}" Width="120"/>
                                <DataGridTextColumn Header="План. заверш." Binding="{Binding PlannedFinishAt, StringFormat=dd.MM.yyyy}" Width="96"/>
                                <DataGridTextColumn Header="Себестоимость" Binding="{Binding UnitCost, StringFormat=N2}" Width="96"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <TabItem Header="Проверки">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <Button Content="Синхронизировать" Command="{Binding RefreshVerificationsCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <TextBlock Text="Проверки и замечания привязаны к задачам. Выберите задачу на разделе «Задачи»."
                                       Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" FontSize="11" TextWrapping="Wrap"/>
                        </StackPanel>
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,12" Visibility="{Binding AllowVerification, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="Добавить проверку" Command="{Binding AddVerificationCommand}" Style="{DynamicResource PrimaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Добавить замечание" Command="{Binding AddRemarkCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                            <Button Content="Паспорт задачи" Command="{Binding ShowPassportCommand}" Style="{DynamicResource SecondaryButton}"/>
                        </StackPanel>
                        <TabControl Grid.Row="2" Padding="0" BorderThickness="0" Background="Transparent">
                            <TabItem Header="Проверки">
                                <DataGrid ItemsSource="{Binding Verifications}" Style="{StaticResource ModernDataGridStyle}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Задача №" Binding="{Binding WorkTaskId}" Width="70"/>
                                        <DataGridTextColumn Header="Категория" Binding="{Binding WorkTask.Category.Name}" Width="110"/>
                                        <DataGridTextColumn Header="Процедура" Binding="{Binding ProcedureName}" Width="*"/>
                                        <DataGridTextColumn Header="Результат" Binding="{Binding ResultValue}" Width="120"/>
                                        <DataGridTextColumn Header="Пройдена" Binding="{Binding Passed}" Width="70"/>
                                        <DataGridTextColumn Header="Дата" Binding="{Binding VerifiedAt, StringFormat=dd.MM.yyyy}" Width="90"/>
                                        <DataGridTextColumn Header="Сертификат" Binding="{Binding CertificateNumber}" Width="90"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                            <TabItem Header="Замечания">
                                <DataGrid ItemsSource="{Binding Remarks}" Style="{StaticResource ModernDataGridStyle}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Задача №" Binding="{Binding WorkTaskId}" Width="70"/>
                                        <DataGridTextColumn Header="Категория" Binding="{Binding WorkTask.Category.Name}" Width="110"/>
                                        <DataGridTextColumn Header="Тип" Binding="{Binding RemarkType}" Width="*"/>
                                        <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="180"/>
                                        <DataGridTextColumn Header="Дата" Binding="{Binding RecordedAt, StringFormat=dd.MM.yyyy}" Width="90"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                        </TabControl>
                    </Grid>
                </TabItem>

                <TabItem Header="Обзор">
                    <Grid Margin="0,0,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <WrapPanel Grid.Row="0" Margin="0,0,0,16">
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="20,14" Margin="0,0,12,10" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="Задач за сегодня" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding TasksToday}" FontSize="26" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}"/>
                                </StackPanel>
                            </Border>
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="20,14" Margin="0,0,12,10" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="В работе" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding TasksInProgress}" FontSize="26" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}"/>
                                </StackPanel>
                            </Border>
                            <Button Content="Синхронизировать" Command="{Binding RefreshOverviewCommand}" Style="{DynamicResource SecondaryButton}" VerticalAlignment="Center" Margin="0,0,0,10"/>
                        </WrapPanel>
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="14" Margin="0,0,6,0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="Низкие остатки" FontSize="13" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                    <ItemsControl ItemsSource="{Binding LowStockItems}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,2">
                                                    <Run Text="{Binding Code}"/> — <Run Text="{Binding Name}"/>: <Run Text="{Binding Quantity}"/>/<Run Text="{Binding MinStock}"/>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                            <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="14" Margin="6,0,0,0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="Срочные задачи" FontSize="13" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                    <ItemsControl ItemsSource="{Binding UrgentTasksList}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,2">
                                                    <Run Text="{Binding Id, StringFormat='№{0} '}"/>
                                                    <Run Text="{Binding CategoryName}"/>
                                                    <Run Text=" — "/>
                                                    <Run Text="{Binding PhaseName}"/>
                                                    <Run Text="{Binding PlannedFinishAt, StringFormat=' ({0:dd.MM.yyyy})'}"/>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>
    </Grid>
</Window>
