<Window x:Class="TelecomProd.Shell.Screens.DashboardWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:TelecomProd.Shell.ViewModels"
        Title="TelecomProd — Управление производственным циклом" Height="760" Width="1200" WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}" FontFamily="{StaticResource AppFont}">
    <Window.DataContext><vm:DashboardViewModel/></Window.DataContext>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="52"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{DynamicResource TopBarBrush}" Padding="20,0">
            <Grid>
                <TextBlock Text="TelecomProd" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button Content="Панель" Command="{Binding GoToDashboardCommand}" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                    <Button Content="Компоненты" Command="{Binding GoToComponentsCommand}" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                    <Button Content="Заказы" Command="{Binding GoToOrdersCommand}" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                    <Button Content="Качество" Command="{Binding GoToQualityCommand}" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                    <Button Content="Отчёты" Command="{Binding GoToReportsCommand}" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                    <Button x:Name="ThemeToggleBtn" Content="Светлая тема" Click="ThemeToggle_Click" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                    <Separator Margin="8,0" Background="#475569" Width="1" VerticalAlignment="Center"/>
                    <Button Content="Выход" Command="{Binding EndSessionCommand}" Foreground="{DynamicResource AccentBrush}" Style="{DynamicResource SecondaryButton}" Margin="6,0" Padding="16,8"/>
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="1" Margin="20,16">
            <TabControl SelectedIndex="{Binding ActivePageIndex, Mode=TwoWay}" Padding="0" BorderThickness="0" Background="Transparent">
                <TabControl.Template>
                    <ControlTemplate TargetType="TabControl">
                        <Grid>
                            <ContentPresenter ContentSource="SelectedContent" Margin="0"/>
                        </Grid>
                    </ControlTemplate>
                </TabControl.Template>

                <!-- 1. Главная панель (Dashboard) -->
                <TabItem Header="Панель">
                    <Grid Margin="0,16,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <WrapPanel Grid.Row="0" Margin="0,0,0,20">
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="24,16" Margin="0,0,16,12" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="Заказов сегодня" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding OrdersToday}" FontSize="28" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}"/>
                                </StackPanel>
                            </Border>
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="24,16" Margin="0,0,16,12" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="В производстве" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding OrdersInProgress}" FontSize="28" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}"/>
                                </StackPanel>
                            </Border>
                            <Button Content="Обновить" Command="{Binding RefreshDashboardCommand}" Style="{DynamicResource SecondaryButton}" VerticalAlignment="Center" Margin="0,0,0,12"/>
                        </WrapPanel>
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16" Margin="0,0,8,0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="Низкие остатки" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>
                                    <ItemsControl ItemsSource="{Binding LowStockItems}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,2">
                                                    <Run Text="{Binding Code}"/> — <Run Text="{Binding Name}"/>: <Run Text="{Binding Quantity}"/>/<Run Text="{Binding MinStock}"/>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                            <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="16" Margin="8,0,0,0" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                <StackPanel>
                                    <TextBlock Text="Срочные заказы" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>
                                    <ItemsControl ItemsSource="{Binding UrgentOrdersList}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,2">
                                                    <Run Text="{Binding Id, StringFormat='№{0} '}"/>
                                                    <Run Text="{Binding AssemblyUnit}"/>
                                                    <Run Text=" — "/>
                                                    <Run Text="{Binding Status}"/>
                                                    <Run Text="{Binding PlannedFinishAt, StringFormat=' ({0:dd.MM.yyyy})'}"/>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Grid>
                </TabItem>

                <!-- 2. Компоненты и склад -->
                <TabItem Header="Компоненты">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" Padding="14,12" Margin="0,0,0,12" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="6">
                            <Grid>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxStyle}"
                                             BorderThickness="0" Margin="0,0,12,0" Background="Transparent" Width="280" Tag="Поиск..."/>
                                    <TextBlock Text="Штрих-код:" VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,6,0"/>
                                    <TextBox x:Name="BarcodeBox" Text="{Binding BarcodeText, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxStyle}"
                                             Width="180" KeyDown="BarcodeBox_KeyDown" Tag="Сканировать и Enter"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                    <Button Content="История перемещений" Command="{Binding ShowMovementsCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                                    <Button Content="Обновить" Command="{Binding RefreshComponentsCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,8,0"/>
                                    <Button Content="Добавить" Command="{Binding AddComponentCommand}" Style="{DynamicResource PrimaryButton}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding Components}" SelectedItem="{Binding SelectedComponent}" Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Код" Binding="{Binding Code}" Width="110"/>
                                <DataGridTextColumn Header="Наименование" Binding="{Binding Name}" Width="*"/>
                                <DataGridTextColumn Header="Тип" Binding="{Binding ComponentType}" Width="140"/>
                                <DataGridTextColumn Header="Производитель" Binding="{Binding Manufacturer}" Width="120"/>
                                <DataGridTextColumn Header="Остаток" Binding="{Binding TotalStock}" Width="80"/>
                                <DataGridTextColumn Header="Мин/Макс" Binding="{Binding MinStock}" Width="80"/>
                                <DataGridTextColumn Header="Ед. изм." Binding="{Binding UnitOfMeasure}" Width="70"/>
                            </DataGrid.Columns>
                            <DataGrid.ContextMenu>
                                <ContextMenu Background="{DynamicResource SurfaceBrush}" Foreground="{DynamicResource TextPrimaryBrush}"
                                              DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                    <MenuItem Header="Добавить" Command="{Binding AddComponentCommand}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <MenuItem Header="Изменить" Command="{Binding EditComponentCommand}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <MenuItem Header="Удалить" Command="{Binding RemoveComponentCommand}" Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <Separator Visibility="{Binding AllowEdit, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <MenuItem Header="Обновить" Command="{Binding RefreshComponentsCommand}"/>
                                </ContextMenu>
                            </DataGrid.ContextMenu>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <!-- 3. Производственные заказы -->
                <TabItem Header="Заказы">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                            <Button Content="Обновить" Command="{Binding RefreshOrdersCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Новый заказ" Command="{Binding CreateOrderCommand}" Style="{DynamicResource PrimaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Изменить статус" Command="{Binding UpdateOrderStatusCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Конструктор BOM" Command="{Binding OpenBomConstructorCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,16,0"/>
                            <TextBlock Text="Вид:" VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,6,0"/>
                            <RadioButton Content="Таблица" IsChecked="True" GroupName="OrdersView" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" Margin="0,0,8,0" Checked="OrdersViewTable_Checked"/>
                            <RadioButton Content="Канбан" GroupName="OrdersView" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" Checked="OrdersViewKanban_Checked"/>
                        </StackPanel>
                        <ScrollViewer Grid.Row="1" x:Name="KanbanScroll" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Margin="0,0,0,8" Visibility="Collapsed">
                            <ItemsControl x:Name="KanbanItemsControl" ItemsSource="{Binding OrderColumns}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="200" MinHeight="180" Margin="0,0,10,0" Background="#334155" CornerRadius="6" Padding="10">
                                            <StackPanel>
                                                <TextBlock Text="{Binding StatusName}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                                <ItemsControl ItemsSource="{Binding Orders}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="{DynamicResource SurfaceBrush}" Padding="8" Margin="0,0,0,6" CornerRadius="4" Cursor="Hand">
                                                                <StackPanel>
                                                                    <TextBlock Foreground="{DynamicResource TextPrimaryBrush}"><Run Text="№"/><Run Text="{Binding Id}"/></TextBlock>
                                                                    <TextBlock Text="{Binding AssemblyUnit.Name}" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" TextTrimming="CharacterEllipsis"/>
                                                                    <TextBlock Text="{Binding PlannedFinishAt, StringFormat='План: {0:dd.MM.yy}'}" Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <DataGrid Grid.Row="2" x:Name="OrdersDataGrid" ItemsSource="{Binding Orders}" SelectedItem="{Binding SelectedOrder}" Style="{StaticResource ModernDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="№" Binding="{Binding Id}" Width="64"/>
                                <DataGridTextColumn Header="Узел сборки" Binding="{Binding AssemblyUnit.Name}" Width="200"/>
                                <DataGridTextColumn Header="Статус" Binding="{Binding Status.Name}" Width="120"/>
                                <DataGridTextColumn Header="Кол-во" Binding="{Binding Quantity}" Width="70"/>
                                <DataGridTextColumn Header="Дата" Binding="{Binding CreatedAt, StringFormat=dd.MM.yyyy HH:mm}" Width="130"/>
                                <DataGridTextColumn Header="План. заверш." Binding="{Binding PlannedFinishAt, StringFormat=dd.MM.yyyy}" Width="100"/>
                                <DataGridTextColumn Header="Себестоимость" Binding="{Binding UnitCost, StringFormat=N2}" Width="100"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <!-- 4. Контроль качества -->
                <TabItem Header="Качество">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                            <Button Content="Обновить" Command="{Binding RefreshQualityCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <TextBlock Text="Тесты и брак привязаны к заказам. Чтобы добавить — выберите заказ на вкладке «Заказы»." 
                                       Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" FontSize="12" TextWrapping="Wrap"/>
                        </StackPanel>
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,14" Visibility="{Binding AllowQuality, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Content="Добавить тест" Command="{Binding AddQualityTestCommand}" Style="{DynamicResource PrimaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Регистрация брака" Command="{Binding AddDefectCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Паспорт изделия" Command="{Binding ShowPassportCommand}" Style="{DynamicResource SecondaryButton}"/>
                        </StackPanel>
                        <TabControl Grid.Row="2" Padding="0" BorderThickness="0" Background="Transparent">
                            <TabItem Header="Тесты">
                                <DataGrid ItemsSource="{Binding QualityTests}" Style="{StaticResource ModernDataGridStyle}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Заказ №" Binding="{Binding ProductionOrderId}" Width="70"/>
                                        <DataGridTextColumn Header="Узел сборки" Binding="{Binding ProductionOrder.AssemblyUnit.Name}" Width="120"/>
                                        <DataGridTextColumn Header="Процедура" Binding="{Binding TestProcedure}" Width="*"/>
                                        <DataGridTextColumn Header="Результат" Binding="{Binding MeasurementResult}" Width="150"/>
                                        <DataGridTextColumn Header="Пройден" Binding="{Binding Passed}" Width="80"/>
                                        <DataGridTextColumn Header="Дата" Binding="{Binding TestedAt, StringFormat=dd.MM.yyyy}" Width="100"/>
                                        <DataGridTextColumn Header="Сертификат" Binding="{Binding CertificateNumber}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                            <TabItem Header="Брак">
                                <DataGrid ItemsSource="{Binding Defects}" Style="{StaticResource ModernDataGridStyle}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Заказ №" Binding="{Binding ProductionOrderId}" Width="70"/>
                                        <DataGridTextColumn Header="Узел сборки" Binding="{Binding ProductionOrder.AssemblyUnit.Name}" Width="120"/>
                                        <DataGridTextColumn Header="Тип дефекта" Binding="{Binding DefectType}" Width="*"/>
                                        <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="200"/>
                                        <DataGridTextColumn Header="Дата" Binding="{Binding RecordedAt, StringFormat=dd.MM.yyyy}" Width="100"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </TabItem>
                        </TabControl>
                    </Grid>
                </TabItem>

                <!-- 5. Отчётность и аналитика -->
                <TabItem Header="Отчёты">
                    <Grid Margin="0,16,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16">
                            <Button Content="Экспорт компонентов (Excel)" Command="{Binding ExportComponentsCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Экспорт заказов (Excel)" Command="{Binding ExportOrdersCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Экспорт отчёта (PDF)" Command="{Binding ExportPdfCommand}" Style="{DynamicResource SecondaryButton}" Margin="0,0,10,0"/>
                            <Button Content="Email: низкие остатки" Command="{Binding SendLowStockEmailCommand}" Style="{DynamicResource SecondaryButton}"/>
                        </StackPanel>
                        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="24" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Text="Панель ключевых показателей" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,16"/>
                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,16">
                                    <TextBlock Text="{Binding OrdersToday, StringFormat='Заказов сегодня: {0}'}" FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,24,0"/>
                                    <TextBlock Text="{Binding OrdersInProgress, StringFormat='В производстве: {0}'}" FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,24,0"/>
                                    <TextBlock Text="{Binding LowStockCount, StringFormat='Низкие остатки: {0}'}" FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </StackPanel>
                                <Border Grid.Row="2" Background="#1e293b" CornerRadius="6" Padding="16" Margin="0,8,0,0" MinHeight="100">
                                    <TextBlock Text="KPI: заказов сегодня, в производстве, позиций с низким остатком — см. значения выше" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </Border>
                            </Grid>
                        </Border>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>
    </Grid>
</Window>
